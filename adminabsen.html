<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | PRADUPTA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        :root {
            --bg-dark: #0f172a;
            --accent-blue: #38bdf8;
            --glass-bg: rgba(30, 41, 59, 0.7);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark);
            color: #f8fafc;
            background-image: radial-gradient(circle at top right, #1e293b, #0f172a);
            min-height: 100vh;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }

        .neo-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(56, 189, 248, 0.2);
            color: white;
            transition: all 0.3s ease;
        }

        .neo-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
            outline: none;
        }

        .btn-neon {
            background: linear-gradient(135deg, #0ea5e9, #2563eb);
            transition: all 0.3s ease;
            text-shadow: 0 0 8px rgba(255,255,255,0.3);
        }

        .btn-neon:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
        }

        #loader { 
            display: none; position: fixed; inset: 0; 
            background: rgba(15, 23, 42, 0.9); z-index: 999; 
            flex-direction: column; align-items: center; justify-content: center; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loader">
        <div class="relative w-16 h-16">
            <div class="absolute inset-0 rounded-full border-4 border-blue-500/20"></div>
            <div class="absolute inset-0 rounded-full border-4 border-t-blue-400 animate-spin"></div>
        </div>
        <p class="mt-4 font-bold text-blue-400 tracking-widest uppercase text-[10px]">Sinkronisasi Data...</p>
    </div>

    <div class="max-w-3xl mx-auto space-y-6">
        <header class="flex items-center justify-between glass-card p-6 border-l-4 border-l-blue-500">
            <div>
                <h1 class="text-xl font-extrabold tracking-tight text-white uppercase italic">
                    PRADUPTA <span class="text-blue-400 font-light">Admin</span>
                </h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-[0.3em]">Management Console v2.8</p>
            </div>
            <div class="h-10 w-10 bg-blue-500/10 rounded-full flex items-center justify-center border border-blue-500/30">
                <i class="fas fa-shield-halved text-blue-400"></i>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <section class="glass-card p-6 space-y-4">
                <h2 class="text-xs font-black uppercase text-blue-400 tracking-widest mb-4 flex items-center">
                    <i class="fas fa-cog mr-2"></i> Konfigurasi Ambalan
                </h2>
                <div>
                    <label class="text-[9px] font-bold text-slate-500 uppercase block mb-1 ml-1">Nama Organisasi</label>
                    <input type="text" id="admin-school" class="w-full neo-input p-3 rounded-xl text-sm font-semibold">
                </div>
                <button onclick="upSekolah()" class="w-full btn-neon text-white py-3 rounded-xl font-bold text-[10px] uppercase">Update Nama</button>
            </section>

            <section class="glass-card p-6 space-y-4">
                <h2 class="text-xs font-black uppercase text-blue-400 tracking-widest mb-4 flex items-center">
                    <i class="fas fa-layer-group mr-2"></i> Kelola Divisi
                </h2>
                <div>
                    <label class="text-[9px] font-bold text-slate-500 uppercase block mb-1 ml-1">Nama Divisi Baru</label>
                    <input type="text" id="admin-class" placeholder="Contoh: Unit Media" class="w-full neo-input p-3 rounded-xl text-sm font-semibold">
                </div>
                <button onclick="addKelas()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold text-[10px] uppercase transition-all">Tambah Divisi</button>
            </section>
        </div>

        <section class="glass-card p-6 space-y-4">
            <h2 class="text-xs font-black uppercase text-blue-400 tracking-widest mb-4 flex items-center">
                <i class="fas fa-users-viewfinder mr-2"></i> Import Data Anggota
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-1">
                    <label class="text-[9px] font-bold text-slate-500 uppercase block mb-1 ml-1">Pilih Target Divisi</label>
                    <select id="admin-class-list" class="w-full neo-input p-3 rounded-xl text-sm font-semibold"></select>
                </div>
                <div class="md:col-span-2">
                    <label class="text-[9px] font-bold text-slate-500 uppercase block mb-1 ml-1">Daftar Nama (Satu baris satu nama)</label>
                    <textarea id="admin-bulk-students" class="w-full neo-input p-3 rounded-xl text-sm h-32 font-medium" placeholder="Andi Pratama&#10;Siti Aminah..."></textarea>
                </div>
            </div>
            <button onclick="addSiswaMassal()" class="w-full btn-neon text-white py-4 rounded-xl font-black text-xs uppercase tracking-widest">Eksekusi Import Data</button>
        </section>

        <section class="glass-card p-8 border-t-2 border-t-emerald-500/50">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="text-center md:text-left">
                    <h3 class="text-lg font-bold text-white">Laporan Kehadiran</h3>
                    <p class="text-xs text-slate-400">Unduh data riwayat absensi dalam format PDF resmi.</p>
                </div>
                <button onclick="unduhLaporanPDF()" class="w-full md:w-auto bg-emerald-600 hover:bg-emerald-500 text-white px-10 py-4 rounded-2xl font-black text-xs uppercase shadow-lg shadow-emerald-900/20 transition-all flex items-center justify-center">
                    <i class="fas fa-download mr-3 text-lg"></i> Unduh PDF
                </button>
            </div>
        </section>

        <footer class="text-center py-6">
            <p class="text-[9px] font-bold text-slate-600 uppercase tracking-[0.5em]">System Securely Encrypted by Pradupta</p>
        </footer>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx_YYxl1DM_rpfznIy6Mu7UYlKSZO1edqxDR1K6lVAJqy3oEXDUabe74HQbtsF4g61XHA/exec";
        let config = {};

        async function callBackend(action, data = {}) {
            const response = await fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify({ action, data })
            });
            const json = await response.json();
            return json.result;
        }

        async function loadConfig() {
            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await callBackend("getAppConfig");
                config = res;
                document.getElementById('admin-school').value = res.school;
                const adminClassList = document.getElementById('admin-class-list');
                adminClassList.innerHTML = '<option value="">-- Pilih Divisi --</option>';
                res.classes.forEach(c => {
                    const o = document.createElement('option'); o.value = o.text = c;
                    adminClassList.add(o);
                });
            } catch (e) {
                console.error(e);
            }
            document.getElementById('loader').style.display = 'none';
        }

        async function upSekolah() {
            const n = document.getElementById('admin-school').value;
            if(!n) return;
            document.getElementById('loader').style.display = 'flex';
            await callBackend("updateSchoolName", { newName: n });
            Swal.fire({ icon: 'success', title: 'Updated!', background: '#1e293b', color: '#fff' }).then(loadConfig);
        }

        async function addKelas() {
            const c = document.getElementById('admin-class').value;
            if(!c) return;
            document.getElementById('loader').style.display = 'flex';
            await callBackend("addNewClass", { className: c });
            document.getElementById('admin-class').value = "";
            Swal.fire({ icon: 'success', title: 'Added!', background: '#1e293b', color: '#fff' }).then(loadConfig);
        }

        function addSiswaMassal() {
            const kls = document.getElementById('admin-class-list').value;
            const bulkText = document.getElementById('admin-bulk-students').value;
            if(!kls || !bulkText) return Swal.fire({ icon: 'error', title: 'Oops...', text: 'Data tidak lengkap!', background: '#1e293b', color: '#fff' });

            const namesArray = bulkText.split('\n').map(n => n.trim()).filter(n => n !== "");
            
            Swal.fire({
                title: 'Konfirmasi',
                text: `Import ${namesArray.length} data ke ${kls}?`,
                icon: 'question',
                showCancelButton: true,
                background: '#1e293b',
                color: '#fff',
                confirmButtonColor: '#0ea5e9'
            }).then(async (res) => {
                if (res.isConfirmed) {
                    document.getElementById('loader').style.display = 'flex';
                    await callBackend("addBulkStudents", { namesArray, className: kls });
                    document.getElementById('admin-bulk-students').value = "";
                    Swal.fire({ icon: 'success', title: 'Berhasil!', background: '#1e293b', color: '#fff' }).then(loadConfig);
                }
            });
        }

        async function unduhLaporanPDF() {
            document.getElementById('loader').style.display = 'flex';
            const data = await callBackend("ambilSemuaData");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            doc.setFillColor(15, 23, 42);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18).setFont("helvetica","bold").text(config.school, 105, 18, {align:"center"});
            doc.setFontSize(10).setFont("helvetica","normal").text("Ambalan Raden Aria Wangsakara & Nyimas Melati", 105, 26, {align:"center"});

            doc.autoTable({ 
                startY: 45, 
                head: [['No','Waktu','Divisi','Nama','Status']], 
                body: data.map((r,i)=>[i+1, r[1], r[2], r[3], r[4]]),
                headStyles: { fillColor: [14, 165, 233] },
                alternateRowStyles: { fillColor: [241, 245, 249] },
                styles: { fontSize: 8 }
            });

            doc.save(`Laporan_Pradupta_${new Date().getTime()}.pdf`);
            document.getElementById('loader').style.display = 'none';
        }

        window.onload = loadConfig;
    </script>
</body>
</html>
